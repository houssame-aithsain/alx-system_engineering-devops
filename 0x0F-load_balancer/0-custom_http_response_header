#!/usr/bin/env bash
# shellcheck disable=SC2154
# Configures a new Ubuntu machine with nginx and customizes HTTP response headers

# Update and install nginx
sudo apt-get update
sudo apt-get install nginx -y

# Allow HTTP traffic through the firewall
sudo ufw allow 'Nginx HTTP'

# Replace the default nginx page
echo "Holberton School" | sudo tee /var/www/html/index.nginx-debian.html

# Configure nginx to redirect /redirect_me to YouTube
new_string="listen 80 default_server;\\n\\tlocation /redirect_me {\\n\\t\\treturn 301 https://www.youtube.com/;\\n\\t}"
sudo sed -i "s/listen 80 default_server;/$new_string/" /etc/nginx/sites-available/default

# Correct the path for the custom 404 page
echo "Ceci n'est pas une page" | sudo tee /var/www/html/404.html

# Configure nginx to use the custom 404 page
new_string="listen 80 default_server;\\nerror_page 404 /404.html;\\n\\tlocation = /404.html {\\n\\t\\troot /var/www/html;\\n\\t\\tinternal;\\n\\t}"
sudo sed -i "s/listen 80 default_server;/$new_string/" /etc/nginx/sites-available/default

# Add the custom header X-Served-By with the hostname of the server
new_string2="http {\\n\\tadd_header X-Served-By \"\$HOSTNAME\";"
sudo sed -i "s/http {/$new_string2/" /etc/nginx/nginx.conf

# Start nginx service
sudo service nginx restart
